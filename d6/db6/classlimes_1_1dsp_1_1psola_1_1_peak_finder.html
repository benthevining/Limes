<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Limes: limes::dsp::psola::PeakFinder&lt; SampleType &gt; Class Template Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "ams.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Limes
   &#160;<span id="projectnumber">4.8.1</span>
   </div>
   <div id="projectbrief">C++ utilities and building blocks</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="../../da/d67/classlimes_1_1dsp_1_1psola_1_1_peak_finder-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">limes::dsp::psola::PeakFinder&lt; SampleType &gt; Class Template Reference<span class="mlabels"><span class="mlabel">final</span></span><div class="ingroups"><a class="el" href="../../d1/dbd/group__limes.html">Limes</a> &raquo; <a class="el" href="../../d0/d7b/group__limes__audio.html">limes_audio</a> &raquo; <a class="el" href="../../d2/d79/group__psola.html">PSOLA</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p><code>#include &lt;<a class="el" href="../../dc/dad/_peak_finder_8h_source.html">PeakFinder.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a8f25caf391d138794c0849b40d8dd9ba"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html#a8f25caf391d138794c0849b40d8dd9ba">PeakFinder</a> ()=default</td></tr>
<tr class="memdesc:a8f25caf391d138794c0849b40d8dd9ba"><td class="mdescLeft">&#160;</td><td class="mdescRight">Constructor.  <a href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html#a8f25caf391d138794c0849b40d8dd9ba">More...</a><br /></td></tr>
<tr class="separator:a8f25caf391d138794c0849b40d8dd9ba"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a42b1862be4650d287290de0c22af0be4"><td class="memItemLeft" align="right" valign="top">const <a class="el" href="../../df/d0d/classlimes_1_1ds_1_1scalar__vector.html">ds::scalar_vector</a>&lt; int &gt; &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html#a42b1862be4650d287290de0c22af0be4">findPeaks</a> (const SampleType *const inputSamples, int numSamples, float period) noexcept</td></tr>
<tr class="memdesc:a42b1862be4650d287290de0c22af0be4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Analyzes a stream of audio and identifies the best set of pitch peaks to use for PSOLA pitch shifting.  <a href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html#a42b1862be4650d287290de0c22af0be4">More...</a><br /></td></tr>
<tr class="separator:a42b1862be4650d287290de0c22af0be4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a28e5fbc5c919ee69e2e7ef26b1c6c1e5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html#a28e5fbc5c919ee69e2e7ef26b1c6c1e5">prepare</a> (int maxBlocksize)</td></tr>
<tr class="memdesc:a28e5fbc5c919ee69e2e7ef26b1c6c1e5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Prepares the analyzer for a new maximum blocksize.  <a href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html#a28e5fbc5c919ee69e2e7ef26b1c6c1e5">More...</a><br /></td></tr>
<tr class="separator:a28e5fbc5c919ee69e2e7ef26b1c6c1e5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a003bd2109db0ff54237f27e6de2b7883"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html#a003bd2109db0ff54237f27e6de2b7883">releaseResources</a> ()</td></tr>
<tr class="memdesc:a003bd2109db0ff54237f27e6de2b7883"><td class="mdescLeft">&#160;</td><td class="mdescRight">Releases all resources used by the analyzer.  <a href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html#a003bd2109db0ff54237f27e6de2b7883">More...</a><br /></td></tr>
<tr class="separator:a003bd2109db0ff54237f27e6de2b7883"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adb00d0c87150523d6f3a31833f6dcf5c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html#adb00d0c87150523d6f3a31833f6dcf5c">reset</a> ()</td></tr>
<tr class="memdesc:adb00d0c87150523d6f3a31833f6dcf5c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Resets the analyzer to its initial state, without freeing any resources.  <a href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html#adb00d0c87150523d6f3a31833f6dcf5c">More...</a><br /></td></tr>
<tr class="separator:adb00d0c87150523d6f3a31833f6dcf5c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><h3>template&lt;Sample SampleType&gt;<br />
class limes::dsp::psola::PeakFinder&lt; SampleType &gt;</h3>

<p>A class that identifies pitch peaks for PSOLA pitch shifting. You probably won't ever need to use this class directly, as it's mainly intended as a utility for the Analyzer class.</p>
<p>Pitch peak locations are used to locate and extract from the original signal a series of "grains" which are then respaced by the <a class="el" href="../../d0/dfd/classlimes_1_1dsp_1_1psola_1_1_shifter.html" title="A class that repitches a stream of monophonic audio using PSOLA-like techniques.">Shifter</a> class.</p>
<p>Ultimately, the grains themselves are chosen using these heuristics:</p><ul>
<li>Grains should be about 2 periods long</li>
<li>Grains should have about 50% overlap</li>
<li>Each grain should be about centered on the local maxima in the signal</li>
</ul>
<p>The set of grains that maximizes these criteria is chosen, and what is returned is a list of sample indices representing the <em>middle</em> sample of each grain (ie, the peak that the grain should be centered on).</p>
<h1><a class="anchor" id="peak_alg"></a>
The algorithm</h1>
<p>This is a completely custom algorithm based on several sources, including <b>[chalamandaris_tsiakoulis_karabetsos_raptis_2009]</b> and <b>[colotte_laprie]</b> .</p>
<p>Peaks are searched for in the input signal in a sequence of overlapping analysis windows, which are 1 period long and overlap by 50% &ndash; so analysis window #2 begins at sample \( \frac{\tau}{2} \), analysis window #3 begins at sample \( \tau \), etc, until the entire frame of audio has been covered by an analysis window. One peak is chosen within each analysis window.</p>
<p>This windowing scheme is used because the resulting grains used in the pitch shifting are meant to be 2 periods long, overlapping by 50% &ndash; so if we identify a peak in the signal roughly once per period, then if we center 2-period long grains on each of these peaks, these grains should end up overlapping one another by roughly 50%.</p>
<h2><a class="anchor" id="peak_cand_sel"></a>
Peak candidate selection</h2>
<p>For each analysis window, its <em>predicted peak</em> location is the sample index exactly 1 period greater than the previous analysis window's chosen peak: </p><p class="formulaDsp">
\[ pidx_t=idx\prime+\tau \]
</p>
<p> where:</p><ul>
<li>\( idx\prime \) is the chosen peak index for the previous analysis window;</li>
<li>\( \tau \) is the period of this frame of audio.</li>
</ul>
<p>However, the peak chosen for this analysis window may not be exactly at this location, if the signal demonstrates significant energy in a slightly different area.</p>
<p>Therefore, a set of <em>peak candidates</em> for this analysis window are identified by weighting the original sample values based on how close the sample is to the <em>predicted peak</em> location, and then choosing the set of sample indices whose weighted sample values have the greatest absolute values.</p>
<p>The set of peak candidates for the analysis window beginning at sample \( t \) is defined as: </p><p class="formulaDsp">
\[ C_t=\{\, \max{(1-\frac{\lvert pidx_t-i\rvert}{N_t})\lvert x_i\rvert} \notin C_t : |C_t|\le 15 \,\} \]
</p>
<p> where:</p><ul>
<li>\( i \) is the sample index in the original audio signal which is being evaluated as a potential peak candidate;</li>
<li>\( N_t \) is the number of samples in this analysis window.</li>
</ul>
<p>This algorithm selects 15 initial peak candidates within each analysis window. This number is somewhat arbitrary. Fewer than 15 candidates may be chosen if only a small set of candidates have significant signal power close to the predicted peak.</p>
<h2><a class="anchor" id="peak_can_eval"></a>
Peak candidate evaluation</h2>
<p>Once the set of peak candidates \( C_t \) has been identified, the actual location of the peak for this analysis window is chosen using a more involved weighting scheme.</p>
<p>Because the actual grains created from the selected peaks are <em>two periods long</em>, I take into account not only the distance from the previous peak to each candidate, but also the distance to the peak <em>before</em> the previous peak.</p>
<p>For each peak candidate, we now have <em>two</em> predicted peak locations based on previously chosen peaks: </p><p class="formulaDsp">
\[ pidx_t=idx\prime+\tau \]
</p>
 <p class="formulaDsp">
\[ pidx\prime_t=idx&#39;&#39;+2\tau \]
</p>
<p> where:</p><ul>
<li>\( idx\prime \) is the chosen peak index for the previous analysis window;</li>
<li>\( \tau \) is the period of this frame of audio;</li>
<li>\( idx&#39;&#39; \) is the chosen peak for the analysis frame <em>before</em> the previous one.</li>
</ul>
<p>For each peak candidate, a delta value is calculated which represents its amount of jitter from both of these predicted peaks: </p><p class="formulaDsp">
\[ \delta_c=\lvert c-pidx_t\rvert+\lvert c-pidx\prime_t\rvert \]
</p>
<p> where \( c \) is the sample index of the peak candidate being tested.</p>
<p>The final peak is chosen from the candidates by again comparing weighted sample values, this time with the samples weighted by the candidates' \( \delta_c \) values. The weighted sample value for peak candidate \( c \) is defined by: </p><p class="formulaDsp">
\[ w(c)=\lvert x_c\rvert(1-\frac{\delta_c}{\delta_R}) \]
</p>
<p> where:</p><ul>
<li>\( x_c \) is the value of the sample at index \( c \) in the original input signal;</li>
<li>\( \delta_R \) is the range between the minimum and maximum \( \delta_c \) values of any remaining peak candidate.</li>
</ul>
<p>The peak candidate with the highest resulting \( w(c) \) value is chosen as the peak for this analysis window.</p>
<dl class="section see"><dt>See also</dt><dd>Analyzer </dd></dl>

<p class="definition">Definition at line <a class="el" href="../../dc/dad/_peak_finder_8h_source.html#l00121">121</a> of file <a class="el" href="../../dc/dad/_peak_finder_8h_source.html">PeakFinder.h</a>.</p>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="a8f25caf391d138794c0849b40d8dd9ba"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8f25caf391d138794c0849b40d8dd9ba">&#9670;&nbsp;</a></span>PeakFinder()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;Sample SampleType&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html">limes::dsp::psola::PeakFinder</a>&lt; SampleType &gt;::<a class="el" href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html">PeakFinder</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">default</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Constructor. </p>

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="a42b1862be4650d287290de0c22af0be4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a42b1862be4650d287290de0c22af0be4">&#9670;&nbsp;</a></span>findPeaks()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;Sample SampleType&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const <a class="el" href="../../df/d0d/classlimes_1_1ds_1_1scalar__vector.html">ds::scalar_vector</a>&lt;int&gt;&amp; <a class="el" href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html">limes::dsp::psola::PeakFinder</a>&lt; SampleType &gt;::findPeaks </td>
          <td>(</td>
          <td class="paramtype">const SampleType *const&#160;</td>
          <td class="paramname"><em>inputSamples</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>numSamples</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>period</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">noexcept</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Analyzes a stream of audio and identifies the best set of pitch peaks to use for PSOLA pitch shifting. </p>
<p>The heuristics are that the grains should be approximately 2 periods long, with approximately 50% overlap, approximately centered on pitch peaks. This algorithm attempts to maximize all three criteria in the stream of selected peaks. To obtain the actual grains' start and end indices from the list of peak indices, you should do <code>peak-period</code> and <code>peak+period</code> , respectively, because the grains are 2 periods long and centered on the peaks. </p>

</div>
</div>
<a id="a28e5fbc5c919ee69e2e7ef26b1c6c1e5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a28e5fbc5c919ee69e2e7ef26b1c6c1e5">&#9670;&nbsp;</a></span>prepare()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;Sample SampleType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html">limes::dsp::psola::PeakFinder</a>&lt; SampleType &gt;::prepare </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>maxBlocksize</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Prepares the analyzer for a new maximum blocksize. </p>
<dl class="section note"><dt>Note</dt><dd>This function may allocate memory, and should not be called from a realtime thread. </dd></dl>

</div>
</div>
<a id="a003bd2109db0ff54237f27e6de2b7883"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a003bd2109db0ff54237f27e6de2b7883">&#9670;&nbsp;</a></span>releaseResources()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;Sample SampleType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html">limes::dsp::psola::PeakFinder</a>&lt; SampleType &gt;::releaseResources </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Releases all resources used by the analyzer. </p>
<dl class="section note"><dt>Note</dt><dd>This function may deallocate memory, and should not be called from a realtime thread. </dd></dl>

</div>
</div>
<a id="adb00d0c87150523d6f3a31833f6dcf5c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adb00d0c87150523d6f3a31833f6dcf5c">&#9670;&nbsp;</a></span>reset()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;Sample SampleType&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html">limes::dsp::psola::PeakFinder</a>&lt; SampleType &gt;::reset </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Resets the analyzer to its initial state, without freeing any resources. </p>
<p>This function is safe to call from a realtime thread. </p>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="../../dc/dad/_peak_finder_8h_source.html">PeakFinder.h</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d9/d44/namespacelimes.html">limes</a></li><li class="navelem"><a class="el" href="../../d4/d00/namespacelimes_1_1dsp.html">dsp</a></li><li class="navelem"><a class="el" href="../../d6/d4e/namespacelimes_1_1dsp_1_1psola.html">psola</a></li><li class="navelem"><a class="el" href="../../d6/db6/classlimes_1_1dsp_1_1psola_1_1_peak_finder.html">PeakFinder</a></li>
    <li class="footer">Generated on Fri Jun 3 2022 05:02:00 for Limes by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
